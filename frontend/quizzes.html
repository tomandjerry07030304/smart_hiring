<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Management - Smart Hiring</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .quiz-container { max-width: 1200px; margin: 40px auto; padding: 32px; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
        .btn-create { padding: 12px 24px; background: linear-gradient(135deg, #4F46E5 0%, #7c3aed 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; }
        .quiz-grid { display: grid; gap: 20px; }
        .quiz-card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .quiz-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        .quiz-description { color: #718096; margin-bottom: 16px; }
        .quiz-stats { display: flex; gap: 24px; padding: 16px; background: #f7fafc; border-radius: 8px; margin: 16px 0; }
        .stat { text-align: center; }
        .stat-value { font-size: 24px; font-weight: 700; color: #4F46E5; }
        .stat-label { font-size: 12px; color: #718096; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 32px; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; }
        .question-selector { max-height: 300px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px; }
        .question-item { padding: 12px; background: #f7fafc; margin-bottom: 8px; border-radius: 8px; cursor: pointer; }
        .question-item.selected { background: #e0e7ff; border: 2px solid #4F46E5; }
        .btn-primary { padding: 14px; background: linear-gradient(135deg, #4F46E5 0%, #7c3aed 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-brand">ðŸŽ¯ Smart Hiring</div>
        <div class="navbar-menu">
            <a href="company.html" class="nav-link">Dashboard</a>
            <a href="questions.html" class="nav-link">Question Bank</a>
            <a href="quizzes.html" class="nav-link active">Quizzes</a>
            <button onclick="logout()" class="btn-logout">Logout</button>
        </div>
    </div>

    <div class="quiz-container">
        <div class="quiz-header">
            <h1>ðŸ“‹ Quiz Management</h1>
            <button class="btn-create" onclick="showCreateModal()">+ Create Quiz</button>
        </div>
        <div class="quiz-grid" id="quizzesGrid"></div>
    </div>

    <div class="modal" id="createModal">
        <div class="modal-content">
            <h2>Create Quiz</h2>
            <form onsubmit="createQuiz(event)">
                <div class="form-group">
                    <label>Quiz Title *</label>
                    <input class="form-input" id="quizTitle" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-textarea" id="quizDescription"></textarea>
                </div>
                <div class="form-group">
                    <label>Duration (minutes) *</label>
                    <input type="number" class="form-input" id="duration" value="60" min="1">
                </div>
                <div class="form-group">
                    <label>Passing Score (%) *</label>
                    <input type="number" class="form-input" id="passingScore" value="70" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>Max Attempts</label>
                    <input type="number" class="form-input" id="maxAttempts" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>Select Questions</label>
                    <div class="question-selector" id="questionSelector"></div>
                </div>
                <button type="submit" class="btn-primary">Create Quiz</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://my-project-smart-hiring.onrender.com/api';
        const authToken = localStorage.getItem('authToken');
        if (!authToken) window.location.href = 'login.html';

        let allQuestions = [];
        let selectedQuestions = new Set();

        async function loadQuestions() {
            const response = await fetch(`${API_URL}/assessments/questions`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if (response.ok) {
                const data = await response.json();
                allQuestions = data.questions;
            }
        }

        function showCreateModal() {
            document.getElementById('createModal').classList.add('active');
            displayQuestionSelector();
        }

        function displayQuestionSelector() {
            const selector = document.getElementById('questionSelector');
            selector.innerHTML = allQuestions.map(q => `
                <div class="question-item" onclick="toggleQuestion('${q._id}')">
                    <strong>${q.question_text}</strong><br>
                    <small>${q.question_type} | ${q.difficulty} | ${q.points} pts</small>
                </div>
            `).join('');
        }

        function toggleQuestion(id) {
            if (selectedQuestions.has(id)) {
                selectedQuestions.delete(id);
            } else {
                selectedQuestions.add(id);
            }
            document.querySelectorAll('.question-item').forEach(item => {
                const qId = item.onclick.toString().match(/'([^']+)'/)[1];
                item.classList.toggle('selected', selectedQuestions.has(qId));
            });
        }

        async function createQuiz(e) {
            e.preventDefault();
            
            const data = {
                title: document.getElementById('quizTitle').value,
                description: document.getElementById('quizDescription').value,
                duration: parseInt(document.getElementById('duration').value) * 60,
                passing_score: parseInt(document.getElementById('passingScore').value),
                max_attempts: parseInt(document.getElementById('maxAttempts').value),
                questions: Array.from(selectedQuestions)
            };

            try {
                const response = await fetch(`${API_URL}/assessments/quizzes`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Quiz created successfully!');
                    document.getElementById('createModal').classList.remove('active');
                    loadQuizzes();
                } else {
                    alert('Failed to create quiz');
                }
            } catch (error) {
                alert('Error creating quiz');
            }
        }

        async function loadQuizzes() {
            const response = await fetch(`${API_URL}/assessments/quizzes`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (response.ok) {
                const data = await response.json();
                displayQuizzes(data.quizzes);
            }
        }

        function displayQuizzes(quizzes) {
            const grid = document.getElementById('quizzesGrid');
            
            if (quizzes.length === 0) {
                grid.innerHTML = '<p style="text-align:center;color:#718096;">No quizzes yet. Create your first quiz!</p>';
                return;
            }

            grid.innerHTML = quizzes.map(q => `
                <div class="quiz-card">
                    <div class="quiz-title">${q.title}</div>
                    <div class="quiz-description">${q.description || 'No description'}</div>
                    <div class="quiz-stats">
                        <div class="stat">
                            <div class="stat-value">${q.questions.length}</div>
                            <div class="stat-label">Questions</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${Math.round(q.duration / 60)}</div>
                            <div class="stat-label">Minutes</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${q.passing_score}%</div>
                            <div class="stat-label">Pass Score</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${q.attempts_count || 0}</div>
                            <div class="stat-label">Attempts</div>
                        </div>
                    </div>
                    <button onclick="viewAnalytics('${q._id}')" style="padding:10px;background:#f7fafc;border:none;border-radius:8px;cursor:pointer;width:100%;">
                        ðŸ“Š View Analytics
                    </button>
                </div>
            `).join('');
        }

        async function viewAnalytics(quizId) {
            const response = await fetch(`${API_URL}/assessments/quizzes/${quizId}/analytics`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (response.ok) {
                const data = await response.json();
                alert(`Quiz Analytics:\n\nTotal Attempts: ${data.total_attempts}\nAverage Score: ${data.average_score}%\nPass Rate: ${data.pass_rate}%\nPassed: ${data.passed_count}\nFailed: ${data.failed_count}`);
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
        }

        loadQuestions().then(loadQuizzes);
    </script>
</body>
</html>
